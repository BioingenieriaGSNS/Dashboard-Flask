{% extends "base.html" %}

{% block title %}Equipos{% endblock %}

{% block extra_css %}
<style>
/* Contenedor principal */
.equipos-wrapper {
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    position: relative;
}

/* Contenedor de headers - separado del cuerpo */
.equipos-header-container {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    overflow-x: auto;
    overflow-y: hidden;
    /* Ocultar scrollbar del header */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
}

.equipos-header-container::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

/* Fila de grupos de headers */
.equipos-header-groups {
    display: grid;
    grid-template-columns: 
        380px    /* Datos de Dominio (Cliente + OST + Estado) */
        1580px   /* Detalle de Ingreso (10 columnas + Fotos) */
        300px    /* Detalle de Observaci√≥n (2 columnas) */
        650px    /* Detalles T√©cnicos (5 columnas) */
        690px    /* Detalles Comerciales (5 columnas) */
        100px;   /* Acciones */
}

.header-group {
    color: white;
    font-weight: 700;
    padding: 1px 15px;
    border: 1px solid #0d2240;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Colores personalizados para cada grupo */
.header-group:nth-child(1) { 
    background: #fff9c4; /* Amarillo clarito - Datos de Dominio */
    color: #333;
    position: sticky;
    left: 0;
    z-index: 60;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.header-group:nth-child(2) { 
    background: #b3e5fc; /* Celeste - Detalle de Ingreso */
    color: #333;
}

.header-group:nth-child(3) { 
    background: #fff9c4; /* Amarillo clarito - Detalle de Observaci√≥n */
    color: #333;
}

.header-group:nth-child(4) { 
    background: #ffffff; /* Blanco - Detalles T√©cnicos */
    color: #333;
    border: 1px solid #ddd;
}

.header-group:nth-child(5) { 
    background: #80deea; /* Turquesa - Detalles Comerciales */
    color: #333;
}

.header-group:nth-child(6) { 
    background: linear-gradient(135deg, #2c5f8d 0%, #1e4d7b 100%); /* Azul - Acciones */
    color: white;
}

/* Grid de headers individuales */
.equipos-header-grid {
    display: grid;
    grid-template-columns: 
        /* Datos de Dominio */
        180px    /* Cliente */
        80px     /* OST */
        120px    /* Estado */
        
        /* Detalle de Ingreso */
        120px    /* Fecha Ingreso */
        120px    /* Remito */
        210px    /* Tipo */
        150px    /* Marca */
        150px    /* Modelo */
        180px    /* Serie */
        200px    /* Accesorios */
        200px    /* Obs. Ingreso */
        150px    /* Fotos */
        100px    /* Prioridad */
        
        /* Detalle de Observaci√≥n */
        150px    /* Fecha Env√≠o */
        150px    /* Proveedor */
        
        /* Detalles T√©cnicos y de seguimiento */
        200px    /* Detalles Reparaci√≥n */
        100px    /* Hrs */
        100px    /* Reingreso */
        100px    /* Informe */
        150px    /* Costo */
        
        /* Detalles Comerciales */
        150px    /* Precio */
        120px    /* OV */
        120px    /* Estado OV */
        150px    /* Fecha Entrega */
        150px    /* Remito Entrega */
        
        /* Acciones */
        100px;   /* Acciones */
}

/* Contenedor del cuerpo con scroll */
.equipos-body-container {
    max-height: 65vh;
    overflow-x: auto;
    overflow-y: auto;
}

/* Grid del cuerpo - mismas columnas */
.equipos-body-grid {
    display: grid;
    grid-template-columns: 
        /* Datos de Dominio */
        180px    /* Cliente */
        80px     /* OST */
        120px    /* Estado */
        
        /* Detalle de Ingreso */
        120px    /* Fecha Ingreso */
        120px    /* Remito */
        210px    /* Tipo */
        150px    /* Marca */
        150px    /* Modelo */
        180px    /* Serie */
        200px    /* Accesorios */
        200px    /* Obs. Ingreso */
        150px    /* Fotos */
        100px    /* Prioridad */
        
        /* Detalle de Observaci√≥n */
        150px    /* Fecha Env√≠o */
        150px    /* Proveedor */
        
        /* Detalles T√©cnicos y de seguimiento */
        200px    /* Detalles Reparaci√≥n */
        100px    /* Hrs */
        100px    /* Reingreso */
        100px    /* Informe */
        150px    /* Costo */
        
        /* Detalles Comerciales */
        150px    /* Precio */
        120px    /* OV */
        120px    /* Estado OV */
        150px    /* Fecha Entrega */
        150px    /* Remito Entrega */
        
        /* Acciones */
        100px;   /* Acciones */
}

/* Headers con colores por defecto (azul) */
.grid-header {
    background-color: #1e4d7b !important;
    color: white !important;
    font-weight: 600;
    padding: 12px 15px;
    border: 1px solid #0d2240;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

/* Colores espec√≠ficos para headers individuales */
/* Cliente, OST, Estado - Amarillo clarito */
.grid-header:nth-child(1),
.grid-header:nth-child(2),
.grid-header:nth-child(3) {
    background-color: #fff9c4 !important;
    color: #333 !important;
    border: 1px solid #ddd;
    position: sticky;
    z-index: 50;
}

.grid-header:nth-child(1) { left: 0; }
.grid-header:nth-child(2) { left: 180px; }
.grid-header:nth-child(3) { 
    left: 260px; 
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Fecha Env√≠o y Proveedor - Amarillo clarito */
.grid-header:nth-child(14),
.grid-header:nth-child(15) {
    background-color: #fff9c4 !important;
    color: #333 !important;
    border: 1px solid #ddd;
}

/* Reingreso - Amarillo clarito */
.grid-header:nth-child(18) {
    background-color: #fff9c4 !important;
    color: #333 !important;
    border: 1px solid #ddd;
}

/* Precio, OV, Estado OV, Fecha Entrega, Remito Entrega - Turquesa */
.grid-header:nth-child(21),
.grid-header:nth-child(22),
.grid-header:nth-child(23),
.grid-header:nth-child(24),
.grid-header:nth-child(25) {
    background-color: #80deea !important;
    color: #333 !important;
    border: 1px solid #4dd0e1;
}

/* Celdas del cuerpo - ALTURA FIJA */
.grid-cell {
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    border-top: none;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    height: 48px; /* Altura fija */
    box-sizing: border-box;
}

/* Celda de Obs. Ingreso con indicador de que hay modal */
.obs-ingreso-cell {
    cursor: pointer;
    background-color: #f0f0f0;
    position: relative;
}

.obs-ingreso-cell:hover {
    background-color: #e0e0e0 !important;
}

.obs-ingreso-cell::after {
    content: "üîç";
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8rem;
}

/* Primeras 3 columnas del cuerpo sticky horizontalmente */
/* Total de columnas ahora: 26 */
.equipos-body-grid > div:nth-child(26n + 1),
.equipos-body-grid > div:nth-child(26n + 2),
.equipos-body-grid > div:nth-child(26n + 3) {
    position: sticky;
    z-index: 20;
}

.equipos-body-grid > div:nth-child(26n + 1) { 
    left: 0;
}

.equipos-body-grid > div:nth-child(26n + 2) { 
    left: 180px;
}

.equipos-body-grid > div:nth-child(26n + 3) { 
    left: 260px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Colores alternados */
.grid-cell[data-row-color="even"] {
    background-color: #e8f4f8;
}

.grid-cell[data-row-color="odd"] {
    background-color: #ffffff;
}

/* Mantener colores en columnas sticky */
.equipos-body-grid > div:nth-child(26n + 1)[data-row-color="even"],
.equipos-body-grid > div:nth-child(26n + 2)[data-row-color="even"],
.equipos-body-grid > div:nth-child(26n + 3)[data-row-color="even"] {
    background-color: #e8f4f8 !important;
}

.equipos-body-grid > div:nth-child(26n + 1)[data-row-color="odd"],
.equipos-body-grid > div:nth-child(26n + 2)[data-row-color="odd"],
.equipos-body-grid > div:nth-child(26n + 3)[data-row-color="odd"] {
    background-color: #ffffff !important;
}

/* Hover en filas */
.grid-cell.hover-active {
    background-color: #d4e9f7 !important;
    cursor: pointer;
}

/* Asegurar que columnas sticky mantengan el color en hover */
.equipos-body-grid > div:nth-child(26n + 1).hover-active,
.equipos-body-grid > div:nth-child(26n + 2).hover-active,
.equipos-body-grid > div:nth-child(26n + 3).hover-active {
    background-color: #d4e9f7 !important;
}

/* Celdas editables */
.grid-cell.editable {
    cursor: text;
}

.grid-cell.editable:focus {
    outline: 2px solid #667eea;
    background-color: #fff3cd !important;
}

/* Asegurar que columnas sticky mantengan color cuando est√°n en focus */
.equipos-body-grid > div:nth-child(26n + 1).editable:focus,
.equipos-body-grid > div:nth-child(26n + 2).editable:focus,
.equipos-body-grid > div:nth-child(26n + 3).editable:focus {
    background-color: #fff3cd !important;
}

/* Celdas editables con select (Tipo y Marca) */
.editable-select {
    cursor: pointer;
    background-color: #f8f9fa;
}

.editable-select:hover {
    background-color: #fff3cd !important;
}

/* Celda de estado con dropdown */
.estado-cell {
    cursor: pointer;
    position: relative;
}

.estado-cell:hover {
    background-color: #fff3cd !important;
}

/* Asegurar que la columna sticky de estado mantenga color en hover */
.equipos-body-grid > div:nth-child(26n + 3).estado-cell:hover {
    background-color: #fff3cd !important;
}

.estado-value {
    width: 100%;
}

.estado-select {
    width: 100%;
    padding: 4px;
    border: 2px solid #667eea;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
}

/* Checkbox styles para campos booleanos */
.checkbox-cell {
    display: flex;
    justify-content: center;
    align-items: center;
}

.checkbox-cell input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Links */
.grid-cell a {
    color: #1e4d7b;
    text-decoration: none;
    margin-right: 8px;
}

.grid-cell a:hover {
    text-decoration: underline;
}

/* Botones */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-content-large {
    max-width: 800px;
    max-height: 90vh;
}

.modal-header {
    padding: 20px;
    border-bottom: 2px solid #1e4d7b;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.search-box {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    margin-bottom: 15px;
}

.search-box:focus {
    outline: none;
    border-color: #667eea;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #ddd;
    text-align: right;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close-btn {
    background: #666;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
}

.close-btn:hover {
    background: #444;
}

/* Modal de Observaci√≥n */
.obs-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
}

.obs-textarea:focus {
    outline: none;
    border-color: #667eea;
}

/* Responsive */
@media (max-width: 768px) {
    .equipos-wrapper {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; color: #1e4d7b;">üñ•Ô∏è Gesti√≥n de Equipos</h2>

<div style="margin-bottom: 1.5rem;">
    <button class="btn btn-primary" onclick="location.href='#'">‚ûï Agregar Nuevo Equipo</button>
</div>

<div class="equipos-wrapper">
    <!-- Header Container -->
    <div class="equipos-header-container">
        <!-- Grupos de headers -->
        <div class="equipos-header-groups">
            <div class="header-group">üìã Datos de Dominio</div>
            <div class="header-group">üì• Detalle de Ingreso</div>
            <div class="header-group">üëÅÔ∏è Detalle de Observaci√≥n</div>
            <div class="header-group">üîß Detalles T√©cnicos y de Seguimiento</div>
            <div class="header-group">üí∞ Detalles Comerciales</div>
            <div class="header-group">‚öôÔ∏è Acciones</div>
        </div>
        
        <!-- Headers individuales -->
        <div class="equipos-header-grid">
            <!-- Datos de Dominio (3) -->
            <div class="grid-header">Cliente</div>
            <div class="grid-header">OST</div>
            <div class="grid-header">Estado</div>
            
            <!-- Detalle de Ingreso (10) -->
            <div class="grid-header">Fecha Ingreso</div>
            <div class="grid-header">Remito</div>
            <div class="grid-header">Tipo</div>
            <div class="grid-header">Marca</div>
            <div class="grid-header">Modelo</div>
            <div class="grid-header">Serie</div>
            <div class="grid-header">Accesorios</div>
            <div class="grid-header">Obs. Ingreso</div>
            <div class="grid-header">Fotos</div>
            <div class="grid-header">Prioridad</div>
            
            <!-- Detalle de Observaci√≥n (2) -->
            <div class="grid-header">Fecha Env√≠o</div>
            <div class="grid-header">Proveedor</div>
            
            <!-- Detalles T√©cnicos (5) -->
            <div class="grid-header">Det. Reparaci√≥n</div>
            <div class="grid-header">Hrs</div>
            <div class="grid-header">Reingreso</div>
            <div class="grid-header">Informe</div>
            <div class="grid-header">Costo</div>
            
            <!-- Detalles Comerciales (5) -->
            <div class="grid-header">Precio</div>
            <div class="grid-header">OV</div>
            <div class="grid-header">Estado OV</div>
            <div class="grid-header">Fecha Entrega</div>
            <div class="grid-header">Remito Entrega</div>
            
            <!-- Acciones (1) -->
            <div class="grid-header">Acciones</div>
        </div>
    </div>

    <!-- Body Container -->
    <div class="equipos-body-container">
        <div class="equipos-body-grid">
            {% for equipo in equipos %}
            {% set row_color = 'even' if loop.index % 2 == 0 else 'odd' %}
            
            <!-- Datos de Dominio -->
            <div class="grid-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                {{ equipo.cliente or 'N/A' }}
            </div>
            <div class="grid-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                {{ equipo.ost or 'N/A' }}
            </div>
            <div class="grid-cell estado-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="estado">
                <span class="estado-value">{{ equipo.estado or 'Pendiente' }}</span>
            </div>
            
            <!-- Detalle de Ingreso -->
            <div class="grid-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                {{ equipo.fecha_ingreso.strftime('%d/%m/%Y') if equipo.fecha_ingreso else 'N/A' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="remito">
                {{ equipo.remito or '' }}
            </div>
            <div class="grid-cell editable-select" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="tipo_equipo" data-type="tipo">
                {{ equipo.tipo_equipo or 'Seleccionar' }}
            </div>
            <div class="grid-cell editable-select" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="marca" data-type="marca">
                {{ equipo.marca or 'Seleccionar' }}
            </div>
            <div class="grid-cell editable-select" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="modelo" data-type="modelo">
                {{ equipo.modelo or 'Seleccionar' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="numero_serie">
                {{ equipo.numero_serie or '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="accesorios">
                {{ equipo.accesorios or '' }}
            </div>
            <!-- Obs. Ingreso con modal -->
            <div class="grid-cell obs-ingreso-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="observacion_ingreso" data-obs-completa="{{ equipo.observacion_ingreso or '' }}">
                {{ (equipo.observacion_ingreso[:30] + '...') if equipo.observacion_ingreso and equipo.observacion_ingreso|length > 30 else (equipo.observacion_ingreso or '') }}
            </div>
            <!-- Fotos -->
            <div class="grid-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                {% set fotos = archivos|selectattr('numero_serie', 'equalto', equipo.numero_serie)|selectattr('categoria', 'equalto', 'falla')|list %}
                {% if fotos %}
                    {% for foto in fotos %}
                    <a href="{{ foto.url_cloudinary }}" target="_blank">üñºÔ∏è</a>
                    {% endfor %}
                {% else %}
                    <span style="color: #999;">-</span>
                {% endif %}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="prioridad">
                {{ equipo.prioridad or '' }}
            </div>
            
            <!-- Detalle de Observaci√≥n -->
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="fecha_envio">
                {{ equipo.fecha_envio.strftime('%d/%m/%Y') if equipo.fecha_envio else '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="proveedor">
                {{ equipo.proveedor or '' }}
            </div>
            
            <!-- Detalles T√©cnicos -->
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="detalles_reparacion">
                {{ (equipo.detalles_reparacion[:30] + '...') if equipo.detalles_reparacion and equipo.detalles_reparacion|length > 30 else (equipo.detalles_reparacion or '') }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="horas_trabajo">
                {{ equipo.horas_trabajo or '' }}
            </div>
            <div class="grid-cell checkbox-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                <input type="checkbox" {% if equipo.reingreso %}checked{% endif %} 
                       data-id="{{ equipo.id }}" data-field="reingreso">
            </div>
            <div class="grid-cell checkbox-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                <input type="checkbox" {% if equipo.informe %}checked{% endif %} 
                       data-id="{{ equipo.id }}" data-field="informe">
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="costo">
                {{ '${:,.2f}'.format(equipo.costo) if equipo.costo else '' }}
            </div>
            
            <!-- Detalles Comerciales -->
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="precio">
                {{ '${:,.2f}'.format(equipo.precio) if equipo.precio else '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="ov">
                {{ equipo.ov or '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="estado_ov">
                {{ equipo.estado_ov or '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="fecha_entrega">
                {{ equipo.fecha_entrega.strftime('%d/%m/%Y') if equipo.fecha_entrega else '' }}
            </div>
            <div class="grid-cell editable" contenteditable="true" data-row="{{ loop.index }}" data-row-color="{{ row_color }}" 
                 data-id="{{ equipo.id }}" data-field="remito_entrega">
                {{ equipo.remito_entrega or '' }}
            </div>
            
            <!-- Acciones -->
            <div class="grid-cell" data-row="{{ loop.index }}" data-row-color="{{ row_color }}">
                <button class="btn btn-primary" onclick="guardarFila({{ equipo.id }})">üíæ</button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
    <strong>üí° Tip:</strong> Las primeras 3 columnas son fijas. Haz clic en "Obs. Ingreso" para ver/editar el texto completo en un modal.
</div>

<!-- Modal de Observaci√≥n de Ingreso -->
<div id="modalObsIngreso" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h3>üìù Observaci√≥n de Ingreso - OST: <span id="obsOST"></span></h3>
        </div>
        <div class="modal-body">
            <textarea id="obsTextarea" class="obs-textarea" placeholder="Escriba la observaci√≥n aqu√≠..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="close-btn" onclick="cerrarModalObs()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarObservacion()">üíæ Guardar</button>
        </div>
    </div>
</div>

<!-- Otros modales contin√∫an igual... -->
<!-- Modal Selector -->
<div id="modalSelector" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="selectorTitle">Seleccionar Opci√≥n</h3>
        </div>
        <div class="modal-body">
            <input type="text" id="selectorSearch" class="search-box" placeholder="Buscar...">
            <div id="selectorList"></div>
        </div>
        <div class="modal-footer">
            <button class="close-btn" onclick="cerrarModalSelector()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal Nuevo Tipo -->
<div id="modalNuevoTipo" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Agregar Nuevo Tipo de Equipo</h3>
        </div>
        <form id="formNuevoTipo">
            <div class="modal-body">
                <input type="text" id="inputNuevoTipo" class="search-box" placeholder="Nombre del tipo..." required>
            </div>
            <div class="modal-footer">
                <button type="button" class="close-btn" onclick="cerrarModalNuevoTipo()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Agregar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Nueva Marca -->
<div id="modalNuevaMarca" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Agregar Nueva Marca</h3>
        </div>
        <form id="formNuevaMarca">
            <div class="modal-body">
                <input type="text" id="inputNuevaMarca" class="search-box" placeholder="Nombre de la marca..." required>
            </div>
            <div class="modal-footer">
                <button type="button" class="close-btn" onclick="cerrarModalNuevaMarca()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Agregar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Nuevo Modelo -->
<div id="modalNuevoModelo" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Agregar Nuevo Modelo</h3>
        </div>
        <form id="formNuevoModelo">
            <div class="modal-body">
                <input type="text" id="inputNuevoModelo" class="search-box" placeholder="Nombre del modelo..." required>
            </div>
            <div class="modal-footer">
                <button type="button" class="close-btn" onclick="cerrarModalNuevoModelo()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Agregar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Sincronizar scroll horizontal entre header y body
const headerContainer = document.querySelector('.equipos-header-container');
const bodyContainer = document.querySelector('.equipos-body-container');

bodyContainer.addEventListener('scroll', function() {
    headerContainer.scrollLeft = this.scrollLeft;
});

headerContainer.addEventListener('scroll', function() {
    bodyContainer.scrollLeft = this.scrollLeft;
});

// Hover efecto para filas
document.querySelectorAll('.grid-cell').forEach(function(cell) {
    const rowIndex = cell.getAttribute('data-row');
    
    cell.addEventListener('mouseenter', function() {
        document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
            c.classList.add('hover-active');
        });
    });
    
    cell.addEventListener('mouseleave', function() {
        document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
            c.classList.remove('hover-active');
        });
    });
});

// Modal de Observaci√≥n de Ingreso
let currentObsCell = null;
let currentObsEquipoId = null;
let currentObsOST = null;

document.querySelectorAll('.obs-ingreso-cell').forEach(function(cell) {
    cell.addEventListener('click', function() {
        currentObsCell = this;
        currentObsEquipoId = this.getAttribute('data-id');
        
        // Obtener OST de la misma fila
        const rowIndex = this.getAttribute('data-row');
        const ostCell = document.querySelector('[data-row="' + rowIndex + '"]');
        currentObsOST = ostCell ? ostCell.textContent.trim() : 'N/A';
        
        // Obtener observaci√≥n completa del atributo
        const obsCompleta = this.getAttribute('data-obs-completa');
        document.getElementById('obsTextarea').value = obsCompleta || '';
        document.getElementById('obsOST').textContent = currentObsOST;
        
        document.getElementById('modalObsIngreso').style.display = 'flex';
    });
});

function cerrarModalObs() {
    document.getElementById('modalObsIngreso').style.display = 'none';
    currentObsCell = null;
    currentObsEquipoId = null;
    currentObsOST = null;
}

function guardarObservacion() {
    if (!currentObsEquipoId) return;
    
    const nuevoTexto = document.getElementById('obsTextarea').value.trim();
    
    fetch('/api/equipo/' + currentObsEquipoId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ observacion_ingreso: nuevoTexto })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Actualizar celda con texto truncado
            const textoMostrar = nuevoTexto.length > 30 ? nuevoTexto.substring(0, 30) + '...' : nuevoTexto;
            currentObsCell.textContent = textoMostrar;
            currentObsCell.setAttribute('data-obs-completa', nuevoTexto);
            
            const rowIndex = currentObsCell.getAttribute('data-row');
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                c.style.backgroundColor = '#d4edda';
            });
            setTimeout(function() {
                document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                    c.style.backgroundColor = '';
                });
            }, 1500);
            
            alert('‚úÖ Observaci√≥n guardada correctamente');
            cerrarModalObs();
        } else {
            alert('‚ùå Error al guardar: ' + (result.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        alert('‚ùå Error de red: ' + error);
    });
}

document.getElementById('modalObsIngreso').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalObs(); }
});

// Guardar celda editable al perder el foco
document.querySelectorAll('.editable').forEach(function(cell) {
    let valorOriginal = cell.textContent.trim();
    
    cell.addEventListener('focus', function() {
        valorOriginal = this.textContent.trim();
        this.style.backgroundColor = '#fff3cd';
    });
    
    cell.addEventListener('blur', function() {
        this.style.backgroundColor = '';
        const nuevoValor = this.textContent.trim();
        
        if (nuevoValor !== valorOriginal) {
            const equipoId = this.getAttribute('data-id');
            const field = this.getAttribute('data-field');
            
            const data = {};
            data[field] = nuevoValor;
            
            fetch('/api/equipo/' + equipoId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    const rowIndex = cell.getAttribute('data-row');
                    document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                        c.style.backgroundColor = '#d4edda';
                    });
                    setTimeout(function() {
                        document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                            c.style.backgroundColor = '';
                        });
                    }, 1500);
                }
            });
        }
    });
});

// Cambio de checkboxes
document.querySelectorAll('.checkbox-cell input[type="checkbox"]').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        const equipoId = this.getAttribute('data-id');
        const field = this.getAttribute('data-field');
        const isChecked = this.checked;
        
        const data = {};
        data[field] = isChecked;
        
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                alert('‚úÖ Campo actualizado');
            }
        });
    });
});

// Click en Estado para cambiar
document.querySelectorAll('.estado-cell').forEach(function(cell) {
    const estados = ['Pendiente', 'En Proceso', 'Completado', 'Entregado', 'Cancelado'];
    
    cell.addEventListener('click', function() {
        const span = this.querySelector('.estado-value');
        const estadoActual = span.textContent.trim();
        
        const select = document.createElement('select');
        select.className = 'estado-select';
        
        estados.forEach(function(estado) {
            const option = document.createElement('option');
            option.value = estado;
            option.textContent = estado;
            if (estado === estadoActual) option.selected = true;
            select.appendChild(option);
        });
        
        span.style.display = 'none';
        this.appendChild(select);
        select.focus();
        
        select.addEventListener('change', function() {
            const nuevoEstado = this.value;
            const equipoId = cell.getAttribute('data-id');
            
            fetch('/api/equipo/' + equipoId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado })
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    span.textContent = nuevoEstado;
                    span.style.display = '';
                    select.remove();
                    
                    const rowIndex = cell.getAttribute('data-row');
                    document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                        c.style.backgroundColor = '#d4edda';
                    });
                    setTimeout(function() {
                        document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                            c.style.backgroundColor = '';
                        });
                    }, 1500);
                }
            });
        });
        
        select.addEventListener('blur', function() {
            span.style.display = '';
            this.remove();
        });
    });
});

function guardarFila(equipoId) {
    alert('üíæ Los cambios se guardan autom√°ticamente al editar cada celda');
}

// Listas de opciones
const TIPOS_EQUIPO = ["Analizador de Gases","Balanza","Bomba de Infusi√≥n","Cama El√©ctrica","Capn√≥grafo","Capn√≥metro","Cardiotoc√≥grafo","Cauterio","Centr√≠fuga","Concentrador de Ox√≠geno","Desfibrilador","Detector Fetal","Doppler","Electrocardiografo","Electrocardi√≥grafo","Emisor de Ultrasonido","Espir√≥metro","Estetoscopio","Fototerapia","L√°mpara Quir√∫rgica","L√≠nea Arterial","Microscopio","Monitor","Monitor Fetal","Monitor Multiparam√©trico","Nebulizador","Negatoscopio","Otoscopio","Ox√≠metro","PC","Pesa","Purificador de Aire","Respirador","Simulador","Simulador Materno-Fetal","Soporte Ventilaci√≥n","Tensiometro Adulto","Tensi√≥metro Pedi√°trico","Ventilador"];

const MARCAS = ["Abbot","Adox","Agilent","Air Sep","Aitecs","Akonic","Alison","Apema","Arcomed","Argas","Argimed","Argus","Arrow","ATI Audiscan II","Bamec","BCI","Bioamerican Science","Biocare","Biolight","Bistos","BLT","BMC","Braun","CAM","Cardiomax","Cardioprint","Cardiot√©cnica","Cavour","CEC","Cegens","Choice","Codemaster","Colden","Comen","Confort Cough","Contec","Covidien","Daiwha","Dasa","Datascope","Datex Ohmeda","Denver Instruments","Desconocido","Dixtal","Dong Jiang","Dr√§ger","Dyne","Eccosur","Edan","Edan/Leex","Ekhoson","Electromedik","Enmind","Enray","Esaote","Everflo","EyM","Faeta","Feas","Fisher&Paykel","For You","Fukuda","General Electric","General Medictech","Gen√©rico","Goldway","Healthdyne","HP","Humidias","Infant Star","Innomed","Innovo","LADIE","Leex","Lifotronic","Long Fian","Lovego","Lowentein","Maquet","Massimo","Maverick","Maxtec","MDV","Med Captain","Med joy","Medifusion","Meditech","Medix","Medrena","Medtronic","Microelectr√≥nica","Micromedical","Mindray","Minicomp","MUX","N/E","Natal Care","Nellcor","Neumovent","Newton","Nihon Kohden","Nikon","Ohmeda","Philips","Pmed","Prestige","Presvac","Radian QBio","Respironics","Roma","San-Jor","Sechrist","Silfab","SK","SLE","Suncare","Sunmed","Super Star","Systel","Takaoka","Unimed","UTAH","Valleylab","Vicking","View Sonic","WechAllyn","WEM","Yuwell"];

const MODELOS_EQUIPO = ["60H","600 S","7B-1","7E-C","7E-G","7F-10","7F-5 Mini","9F-5","Autocat II","Autocat II Wave","Beneheart R3","Biomax 500","BT-350","BT-400","BT-500","C-12R","Capnomac","Capnomac Ultima","Cardiolife","Cardiosuny","Caris Plus","CC20","Cloud","CMS8000","CO2-M01","Covidien","D3","DB9","Desconocido","EN-S7","EN-V7","Evergo","Fabius","Fabius Plus","Fabius Plus XL","Force","Graph","Graphnet TS","HC100","Heart Start","HT-109","iE-101","iE-300","IM8B","iMEC10","Infinity Vista","Jay-5","Jay-5Q","LG103","Libra","M3A","MR810","NP-100","NP-600","OXI-3 Plus","Prisma Vent 40","Prisma Vent 50","Puritan Bennett 560","RG-401","RG-401 Plus","RG-501","RG-501 Plus","S3","Scio Four","SP-50","SP-50 Pro","Spirit 3","Star 8000","System 97","System 97e","Trilogy","Vapor 2000","Vista 120","VP-50","VP-50 Pro","YH-350","YH-360","YH-550","YH-560","YH-725","YH-730","5342","5346"];

let selectorCurrentCell = null;
let selectorCurrentType = null;
let selectorCurrentList = [];

function abrirModalSelector(cell, type, items) {
    selectorCurrentCell = cell;
    selectorCurrentType = type;
    selectorCurrentList = items;
    
    const titles = {
        'tipo': 'Seleccionar Tipo de Equipo',
        'marca': 'Seleccionar Marca',
        'modelo': 'Seleccionar Modelo'
    };
    
    document.getElementById('selectorTitle').textContent = titles[type];
    document.getElementById('selectorSearch').value = '';
    
    renderSelectorList(items);
    document.getElementById('modalSelector').style.display = 'flex';
    document.getElementById('selectorSearch').focus();
}

function cerrarModalSelector() {
    document.getElementById('modalSelector').style.display = 'none';
    selectorCurrentCell = null;
    selectorCurrentType = null;
}

function renderSelectorList(items) {
    const listContainer = document.getElementById('selectorList');
    listContainer.innerHTML = '';
    
    items.forEach(function(item) {
        const div = document.createElement('div');
        div.textContent = item;
        div.style.cssText = 'padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;';
        div.addEventListener('mouseenter', function() { this.style.backgroundColor = '#f0f0f0'; });
        div.addEventListener('mouseleave', function() { this.style.backgroundColor = ''; });
        div.addEventListener('click', function() { seleccionarOpcion(item); });
        listContainer.appendChild(div);
    });
    
    const divAgregar = document.createElement('div');
    divAgregar.innerHTML = '‚ûï <strong>Agregar nuevo...</strong>';
    divAgregar.style.cssText = 'padding: 12px 15px; cursor: pointer; background: #e8f4f8; font-weight: bold; color: #1e4d7b;';
    divAgregar.addEventListener('mouseenter', function() { this.style.backgroundColor = '#d0e7f0'; });
    divAgregar.addEventListener('mouseleave', function() { this.style.backgroundColor = '#e8f4f8'; });
    divAgregar.addEventListener('click', function() {
        cerrarModalSelector();
        const modals = {
            'tipo': 'modalNuevoTipo',
            'marca': 'modalNuevaMarca',
            'modelo': 'modalNuevoModelo'
        };
        document.getElementById(modals[selectorCurrentType]).style.display = 'flex';
    });
    listContainer.appendChild(divAgregar);
}

function seleccionarOpcion(valor) {
    if (!selectorCurrentCell) return;
    
    const equipoId = selectorCurrentCell.getAttribute('data-id');
    const field = selectorCurrentCell.getAttribute('data-field');
    
    selectorCurrentCell.textContent = valor;
    
    const data = {};
    data[field] = valor;
    
    fetch('/api/equipo/' + equipoId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
        if (result.success) {
            const rowIndex = selectorCurrentCell.getAttribute('data-row');
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                c.style.backgroundColor = '#d4edda';
            });
            setTimeout(function() {
                document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                    c.style.backgroundColor = '';
                });
            }, 1500);
        }
    });
    
    cerrarModalSelector();
}

document.getElementById('selectorSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filteredItems = selectorCurrentList.filter(function(item) {
        return item.toLowerCase().includes(searchTerm);
    });
    renderSelectorList(filteredItems);
});

document.querySelectorAll('.editable-select').forEach(function(cell) {
    cell.addEventListener('click', function() {
        const type = this.getAttribute('data-type');
        const lists = {
            'tipo': TIPOS_EQUIPO,
            'marca': MARCAS,
            'modelo': MODELOS_EQUIPO
        };
        abrirModalSelector(this, type, lists[type]);
    });
});

document.getElementById('modalSelector').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalSelector(); }
});

// Modal Nuevo Tipo
function cerrarModalNuevoTipo() {
    document.getElementById('modalNuevoTipo').style.display = 'none';
    document.getElementById('formNuevoTipo').reset();
}

document.getElementById('modalNuevoTipo').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevoTipo(); }
});

document.getElementById('formNuevoTipo').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevoTipo = document.getElementById('inputNuevoTipo').value.trim();
    if (!nuevoTipo) return;
    
    TIPOS_EQUIPO.push(nuevoTipo);
    TIPOS_EQUIPO.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo_equipo: nuevoTipo })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevoTipo;
                alert('‚úÖ Nuevo tipo agregado');
            }
        });
    }
    cerrarModalNuevoTipo();
});

// Modal Nueva Marca
function cerrarModalNuevaMarca() {
    document.getElementById('modalNuevaMarca').style.display = 'none';
    document.getElementById('formNuevaMarca').reset();
}

document.getElementById('modalNuevaMarca').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevaMarca(); }
});

document.getElementById('formNuevaMarca').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevaMarca = document.getElementById('inputNuevaMarca').value.trim();
    if (!nuevaMarca) return;
    
    MARCAS.push(nuevaMarca);
    MARCAS.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ marca: nuevaMarca })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevaMarca;
                alert('‚úÖ Nueva marca agregada');
            }
        });
    }
    cerrarModalNuevaMarca();
});

// Modal Nuevo Modelo
function cerrarModalNuevoModelo() {
    document.getElementById('modalNuevoModelo').style.display = 'none';
    document.getElementById('formNuevoModelo').reset();
}

document.getElementById('modalNuevoModelo').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevoModelo(); }
});

document.getElementById('formNuevoModelo').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevoModelo = document.getElementById('inputNuevoModelo').value.trim();
    if (!nuevoModelo) return;
    
    MODELOS_EQUIPO.push(nuevoModelo);
    MODELOS_EQUIPO.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ modelo: nuevoModelo })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevoModelo;
                alert('‚úÖ Nuevo modelo agregado');
            }
        });
    }
    cerrarModalNuevoModelo();
});
</script>
{% endblock %}