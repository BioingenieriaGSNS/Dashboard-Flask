{% extends "base.html" %}

{% block title %}Equipos{% endblock %}

{% block extra_css %}
<style>
/* Contenedor principal */
.equipos-wrapper {
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    position: relative;
}

/* Contenedor de headers - separado del cuerpo */
.equipos-header-container {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    overflow: hidden;
}

/* Grid de headers */
.equipos-header-grid {
    display: grid;
    grid-template-columns: 
        180px    /* Cliente */
        80px     /* OST */
        120px    /* Estado */
        120px    /* Fecha Ingreso */
        150px    /* Tipo */
        120px    /* Marca */
        150px    /* Modelo */
        180px    /* Serie */
        150px    /* Fotos */
        150px    /* Facturas */
        200px    /* Accesorios */
        100px    /* Prioridad */
        100px;   /* Acciones */
}

/* Contenedor del cuerpo con scroll */
.equipos-body-container {
    max-height: 65vh;
    overflow: auto;
}

/* Grid del cuerpo - mismas columnas */
.equipos-body-grid {
    display: grid;
    grid-template-columns: 
        180px    /* Cliente */
        80px     /* OST */
        120px    /* Estado */
        120px    /* Fecha Ingreso */
        150px    /* Tipo */
        120px    /* Marca */
        150px    /* Modelo */
        180px    /* Serie */
        150px    /* Fotos */
        150px    /* Facturas */
        200px    /* Accesorios */
        100px    /* Prioridad */
        100px;   /* Acciones */
}

/* Headers */
.grid-header {
    background-color: #1e4d7b !important;
    color: white !important;
    font-weight: 600;
    padding: 12px 15px;
    border: 1px solid #0d2240;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

/* Primeros 3 headers sticky horizontalmente */
.grid-header:nth-child(1),
.grid-header:nth-child(2),
.grid-header:nth-child(3) {
    position: sticky;
    z-index: 50;
    background-color: #1e4d7b !important;
}

.grid-header:nth-child(1) { left: 0; }
.grid-header:nth-child(2) { left: 180px; }
.grid-header:nth-child(3) { 
    left: 260px; 
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Celdas del cuerpo */
.grid-cell {
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    border-top: none;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    min-height: 48px;
    box-sizing: border-box;
}

/* Primeras 3 columnas del cuerpo sticky horizontalmente */
.equipos-body-grid > div:nth-child(13n + 1),
.equipos-body-grid > div:nth-child(13n + 2),
.equipos-body-grid > div:nth-child(13n + 3) {
    position: sticky;
    z-index: 10;
}

.equipos-body-grid > div:nth-child(13n + 1) { left: 0; }
.equipos-body-grid > div:nth-child(13n + 2) { left: 180px; }
.equipos-body-grid > div:nth-child(13n + 3) { 
    left: 260px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* Colores alternados */
.grid-cell[data-row-color="even"] {
    background-color: #e8f4f8;
}

.grid-cell[data-row-color="odd"] {
    background-color: #ffffff;
}

/* Mantener colores en columnas sticky */
.equipos-body-grid > div:nth-child(13n + 1)[data-row-color="even"],
.equipos-body-grid > div:nth-child(13n + 2)[data-row-color="even"],
.equipos-body-grid > div:nth-child(13n + 3)[data-row-color="even"] {
    background-color: #e8f4f8;
}

.equipos-body-grid > div:nth-child(13n + 1)[data-row-color="odd"],
.equipos-body-grid > div:nth-child(13n + 2)[data-row-color="odd"],
.equipos-body-grid > div:nth-child(13n + 3)[data-row-color="odd"] {
    background-color: #ffffff;
}

/* Hover en filas */
.grid-cell.hover-active {
    background-color: #d4e9f7 !important;
    cursor: pointer;
}

/* Celdas editables */
.grid-cell.editable {
    cursor: text;
}

.grid-cell.editable:focus {
    outline: 2px solid #667eea;
    background-color: #fff3cd !important;
}

/* Celdas editables con select (Tipo y Marca) */
.editable-select {
    cursor: pointer;
    background-color: #f8f9fa;
}

.editable-select:hover {
    background-color: #fff3cd !important;
}

/* Celda de estado con dropdown */
.estado-cell {
    cursor: pointer;
    position: relative;
}

.estado-cell:hover {
    background-color: #fff3cd !important;
}

.estado-value {
    width: 100%;
}

.estado-select {
    width: 100%;
    padding: 4px;
    border: 2px solid #667eea;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
}

/* Links */
.grid-cell a {
    color: #1e4d7b;
    text-decoration: none;
    margin-right: 8px;
}

.grid-cell a:hover {
    text-decoration: underline;
}

/* Botones */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Scrollbar */
.equipos-body-container::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

.equipos-body-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.equipos-body-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

.equipos-body-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Sincronizar scroll horizontal entre header y body */
.equipos-header-scroll-sync {
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
}

.equipos-header-scroll-sync::-webkit-scrollbar {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; color: #1e4d7b;">üñ•Ô∏è Gesti√≥n de Equipos</h2>

<div style="margin-bottom: 1.5rem;">
    <button class="btn btn-primary" onclick="mostrarModal()">‚ûï Agregar Nuevo Equipo</button>
</div>

<!-- Modal Agregar Equipo -->
<div id="modalEquipo" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 1.5rem; color: #1e4d7b;">üñ•Ô∏è Nuevo Equipo</h3>
        <form id="formEquipo">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ID Solicitud *</label>
                    <input type="number" name="solicitud_id" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">N√∫mero Equipo *</label>
                    <input type="number" name="numero_equipo" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo Equipo *</label>
                    <input type="text" name="tipo_equipo" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Marca</label>
                    <input type="text" name="marca" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Modelo</label>
                    <input type="text" name="modelo" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">N√∫mero de Serie</label>
                    <input type="text" name="numero_serie" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cliente</label>
                    <input type="text" name="cliente" value="Syemed" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Prioridad</label>
                    <select name="prioridad" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="Baja">Baja</option>
                        <option value="Media" selected>Media</option>
                        <option value="Alta">Alta</option>
                        <option value="Cr√≠tica">Cr√≠tica</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Accesorios</label>
                    <textarea name="accesorios" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Observaci√≥n de Ingreso</label>
                    <textarea name="observacion_ingreso" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="cerrarModal()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-primary">üíæ Guardar Equipo</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Selector (Tipo y Marca) -->
<div id="modalSelector" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="selectorTitle" style="margin-bottom: 1rem; color: #1e4d7b;"></h3>
        <input type="text" id="selectorSearch" placeholder="üîç Buscar..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; margin-bottom: 1rem;">
        <div id="selectorList" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; max-height: 400px;"></div>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
            <button type="button" class="btn" onclick="cerrarModalSelector()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Agregar Nuevo Tipo -->
<div id="modalNuevoTipo" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1.5rem; color: #1e4d7b;">‚ûï Agregar Nuevo Tipo de Equipo</h3>
        <form id="formNuevoTipo">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre del Tipo *</label>
                <input type="text" id="inputNuevoTipo" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Este tipo se agregar√° a la lista de opciones disponibles.</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="cerrarModalNuevoTipo()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-primary">‚úÖ Agregar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Agregar Nueva Marca -->
<div id="modalNuevaMarca" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1.5rem; color: #1e4d7b;">‚ûï Agregar Nueva Marca</h3>
        <form id="formNuevaMarca">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre de la Marca *</label>
                <input type="text" id="inputNuevaMarca" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Esta marca se agregar√° a la lista de opciones disponibles.</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="cerrarModalNuevaMarca()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-primary">‚úÖ Agregar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Agregar Nuevo Modelo -->
<div id="modalNuevoModelo" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1.5rem; color: #1e4d7b;">‚ûï Agregar Nuevo Modelo</h3>
        <form id="formNuevoModelo">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre del Modelo *</label>
                <input type="text" id="inputNuevoModelo" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Este modelo se agregar√° a la lista de opciones disponibles.</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="cerrarModalNuevoModelo()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-primary">‚úÖ Agregar</button>
            </div>
        </form>
    </div>
</div>

<div class="equipos-wrapper">
    <!-- HEADERS -->
    <div class="equipos-header-container">
        <div class="equipos-header-scroll-sync" id="headerScroll">
            <div class="equipos-header-grid">
                <div class="grid-header">Cliente</div>
                <div class="grid-header">OST</div>
                <div class="grid-header">Estado</div>
                <div class="grid-header">Fecha Ingreso</div>
                <div class="grid-header">Tipo</div>
                <div class="grid-header">Marca</div>
                <div class="grid-header">Modelo</div>
                <div class="grid-header">Serie</div>
                <div class="grid-header">üì∏ Fotos</div>
                <div class="grid-header">üìÑ Facturas</div>
                <div class="grid-header">Accesorios</div>
                <div class="grid-header">Prioridad</div>
                <div class="grid-header">Acciones</div>
            </div>
        </div>
    </div>

    <!-- CUERPO -->
    <div class="equipos-body-container" id="bodyScroll">
        <div class="equipos-body-grid">
            {% for equipo in equipos %}
                {% set row_color = "even" if loop.index0 % 2 == 0 else "odd" %}
                
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" title="{{ equipo.cliente }}">{{ equipo.cliente }}</div>
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}">{{ equipo.ost }}</div>
                <div class="grid-cell estado-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="estado" title="{{ equipo.estado or 'Pendiente' }}">
                    <span class="estado-value">{{ equipo.estado or 'Pendiente' }}</span>
                    <select class="estado-select" style="display: none;">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Aprobaci√≥n pendiente">Aprobaci√≥n pendiente</option>
                        <option value="A presupuestar">A presupuestar</option>
                        <option value="Baja t√©cnica">Baja t√©cnica</option>
                        <option value="En curso">En curso</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Listo para entregar">Listo para entregar</option>
                        <option value="Repuestos">Repuestos</option>
                        <option value="Tercerizado">Tercerizado</option>
                        <option value="L/E - Faltantes">L/E - Faltantes</option>
                        <option value="Enviado/Falta Remito">Enviado/Falta Remito</option>
                    </select>
                </div>
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}">{{ equipo.fecha_ingreso.strftime('%d/%m/%Y') if equipo.fecha_ingreso else 'N/A' }}</div>
                <div class="grid-cell editable-select" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="tipo_equipo" data-type="tipo" title="{{ equipo.tipo_equipo or 'Click para seleccionar' }}">{{ equipo.tipo_equipo or 'Seleccionar...' }}</div>
                <div class="grid-cell editable-select" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="marca" data-type="marca" title="{{ equipo.marca or 'Click para seleccionar' }}">{{ equipo.marca or 'Seleccionar...' }}</div>
                <div class="grid-cell editable-select" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="modelo" data-type="modelo" title="{{ equipo.modelo or 'Click para seleccionar' }}">{{ equipo.modelo or 'Seleccionar...' }}</div>
                <div class="grid-cell editable" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="numero_serie" contenteditable="true">{{ equipo.numero_serie or '' }}</div>
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}">
                    {% if equipo.urls_fotos_fallas %}
                        {% set urls = equipo.urls_fotos_fallas.split('||') %}
                        {% for url in urls %}
                            {% if url %}
                                <a href="{{ url }}" target="_blank">üñºÔ∏è {{ loop.index }}</a>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        Sin archivos
                    {% endif %}
                </div>
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}">
                    {% if equipo.urls_facturas %}
                        {% set urls = equipo.urls_facturas.split('||') %}
                        {% for url in urls %}
                            {% if url %}
                                <a href="{{ url }}" target="_blank">üìÑ {{ loop.index }}</a>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        Sin archivos
                    {% endif %}
                </div>
                <div class="grid-cell editable" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="accesorios" contenteditable="true">{{ equipo.accesorios or '' }}</div>
                <div class="grid-cell editable" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}" data-id="{{ equipo.id }}" data-field="prioridad" contenteditable="true">{{ equipo.prioridad or '' }}</div>
                <div class="grid-cell" data-row="{{ loop.index0 }}" data-row-color="{{ row_color }}">
                    <button class="btn btn-primary" onclick="guardarFila({{ equipo.id }})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üíæ</button>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Sincronizar scroll horizontal entre header y body
const headerScroll = document.getElementById('headerScroll');
const bodyScroll = document.getElementById('bodyScroll');

let isHeaderScrolling = false;
let isBodyScrolling = false;

bodyScroll.addEventListener('scroll', function() {
    if (!isHeaderScrolling) {
        isBodyScrolling = true;
        headerScroll.scrollLeft = this.scrollLeft;
        setTimeout(function() { isBodyScrolling = false; }, 10);
    }
});

headerScroll.addEventListener('scroll', function() {
    if (!isBodyScrolling) {
        isHeaderScrolling = true;
        bodyScroll.scrollLeft = this.scrollLeft;
        setTimeout(function() { isHeaderScrolling = false; }, 10);
    }
});

// Hover sincronizado en filas
document.querySelectorAll('.grid-cell').forEach(function(cell) {
    cell.addEventListener('mouseenter', function() {
        const rowIndex = this.getAttribute('data-row');
        if (rowIndex !== null) {
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                c.classList.add('hover-active');
            });
        }
    });
    
    cell.addEventListener('mouseleave', function() {
        const rowIndex = this.getAttribute('data-row');
        if (rowIndex !== null) {
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                c.classList.remove('hover-active');
            });
        }
    });
});

// Modal Agregar Equipo
function mostrarModal() {
    document.getElementById('modalEquipo').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalEquipo').style.display = 'none';
    document.getElementById('formEquipo').reset();
}

document.getElementById('modalEquipo').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModal();
    }
});

document.getElementById('formEquipo').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        solicitud_id: parseInt(formData.get('solicitud_id')),
        numero_equipo: parseInt(formData.get('numero_equipo')),
        tipo_equipo: formData.get('tipo_equipo'),
        marca: formData.get('marca'),
        modelo: formData.get('modelo'),
        numero_serie: formData.get('numero_serie'),
        cliente: formData.get('cliente'),
        prioridad: formData.get('prioridad'),
        accesorios: formData.get('accesorios'),
        observacion_ingreso: formData.get('observacion_ingreso')
    };
    
    fetch('/api/equipo/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(result) {
        if (result.success) {
            alert('‚úÖ Equipo agregado correctamente. OST: ' + result.ost);
            cerrarModal();
            location.reload();
        } else {
            alert('‚ùå Error al agregar: ' + (result.error || 'Error desconocido'));
        }
    })
    .catch(function(error) {
        alert('‚ùå Error de red: ' + error);
    });
});

// Guardar fila
function guardarFila(equipoId) {
    const editableCells = document.querySelectorAll('.editable[data-id="' + equipoId + '"]');
    
    const data = {};
    editableCells.forEach(function(cell) {
        const field = cell.getAttribute('data-field');
        data[field] = cell.textContent.trim();
    });
    
    fetch('/api/equipo/' + equipoId, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(result) {
        if (result.success) {
            alert('‚úÖ Equipo actualizado correctamente');
            const rowCells = document.querySelectorAll('[data-id="' + equipoId + '"]');
            const rowIndex = rowCells[0].getAttribute('data-row');
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(cell) {
                cell.style.backgroundColor = '#d4edda';
            });
            setTimeout(function() {
                document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(cell) {
                    cell.style.backgroundColor = '';
                });
            }, 2000);
        } else {
            alert('‚ùå Error al actualizar: ' + (result.error || 'Error desconocido'));
        }
    })
    .catch(function(error) {
        alert('‚ùå Error de red: ' + error);
    });
}

// Celdas editables
document.querySelectorAll('.editable').forEach(function(cell) {
    cell.addEventListener('focus', function() {
        this.style.backgroundColor = '#fff3cd';
    });
    
    cell.addEventListener('blur', function() {
        this.style.backgroundColor = '';
    });
});

// Manejo de dropdown de estado
document.querySelectorAll('.estado-cell').forEach(function(cell) {
    const equipoId = cell.getAttribute('data-id');
    const estadoValue = cell.querySelector('.estado-value');
    const estadoSelect = cell.querySelector('.estado-select');
    
    cell.addEventListener('click', function() {
        estadoValue.style.display = 'none';
        estadoSelect.style.display = 'block';
        estadoSelect.focus();
    });
    
    estadoSelect.addEventListener('change', function() {
        const nuevoEstado = this.value;
        estadoValue.textContent = nuevoEstado;
        
        const data = { estado: nuevoEstado };
        
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                const rowIndex = cell.getAttribute('data-row');
                document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                    c.style.backgroundColor = '#d4edda';
                });
                setTimeout(function() {
                    document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                        c.style.backgroundColor = '';
                    });
                }, 1500);
            }
        });
        
        estadoSelect.style.display = 'none';
        estadoValue.style.display = 'block';
    });
    
    estadoSelect.addEventListener('blur', function() {
        estadoSelect.style.display = 'none';
        estadoValue.style.display = 'block';
    });
});

// Datos de tipos y marcas
const TIPOS_EQUIPO = ["Agitador Orbital","Analizador de gases","Asistente de Tos","Aspirador de secreciones","Aspirador Manual","Audi√≥metro","Autoanalizador","APAP","Balanza de Pie","Balanza de Pie Electr√≥nica","Balanza Electr√≥nica","Balanza Mec√°nica","Balanza Pedi√°trica","Bal√≥n de Contrapulsaci√≥n","Bater√≠a","Bomba a jeringa","BPAP","Cable paciente ECG 5D Vet","Cable paciente ECG 3D","Cable paciente ECG 5D","Cable paciente ECG 10D","Bomba de Infusi√≥n","Bomba de Presi√≥n Negativa","Cables Varios","Calentador Humidificador","Capn√≥grafo","Cardiodesfibrilador","Central de Monitoreo","Centr√≠fuga","Colposcopio","Colposcopio Digital","Concentrador de Ox√≠geno","Concentrador de Ox√≠geno Port√°til","CPAP","CPU","DEA","Desfibrilador","Detector Fetal","Ec√≥grafo","Electrobistur√≠","Electrocardi√≥grafo","Electrocoagulador","Electroencefal√≥grafo","Equipo Presi√≥n Negativa","Estufa de Esterilizaci√≥n","Extensi√≥n SpO2","Fotoestimulador","Fuente de alimentaci√≥n de Balanza","Fuente de alimentaci√≥n de Monitor Fetal","Holter","Incubadora","Luminoterapia","Marcapasos","Manguera PNI","Manguito Cuff PNI","Mesa de Anestesia","Microscopio de banco","Microscopio de pared","Mochila de Ox√≠geno","M√≥dulo de Capnograf√≠a","M√≥dulo de Incubadora","M√≥dulo PI","Monitor Fetal","Monitor Multiparam√©trico","Oxicapn√≥grafo","Ox√≠metro de Pulso","Pedal monopolar Electrobistur√≠","Potenciales Evocados","Respirador","Respirador Port√°til","Sensor de Temperatura","Sensor SpO2 B.Ad.","Sensor SpO2 Neo","Sensor SpO2 Vet","Sensor SpO2 + Extensi√≥n","Transductor Fetal Ultrasonido","Transductor Fetal Tocogineco","Tubo de Ox√≠geno","Vaporizador de anestesia","Video Colposcopio","Pie de Suero"];

const MARCAS = ["Abbot","Adox","Agilent","Air Sep","Aitecs","Akonic","Alison","Apema","Arcomed","Argas","Argimed","Argus","Arrow","ATI Audiscan II","Bamec","BCI","Bioamerican Science","Biocare","Biolight","Bistos","BLT","BMC","Braun","CAM","Cardiomax","Cardioprint","Cardiot√©cnica","Cavour","CEC","Cegens","Choice","Codemaster","Colden","Comen","Confort Cough","Contec","Covidien","Daiwha","Dasa","Datascope","Datex Ohmeda","Denver Instruments","Desconocido","Dixtal","Dong Jiang","Dr√§ger","Dyne","Eccosur","Edan","Edan/Leex","Ekhoson","Electromedik","Enmind","Enray","Esaote","Everflo","EyM","Faeta","Feas","Fisher&Paykel","For You","Fukuda","General Electric","General Medictech","Gen√©rico","Goldway","Healthdyne","HP","Humidias","Infant Star","Innomed","Innovo","LADIE","Leex","Lifotronic","Long Fian","Lovego","Lowentein","Maquet","Massimo","Maverick","Maxtec","MDV","Med Captain","Med joy","Medifusion","Meditech","Medix","Medrena","Medtronic","Microelectr√≥nica","Micromedical","Mindray","Minicomp","MUX","N/E","Natal Care","Nellcor","Neumovent","Newton","Nihon Kohden","Nikon","Ohmeda","Philips","Pmed","Prestige","Presvac","Radian QBio","Respironics","Roma","San-Jor","Sechrist","Silfab","SK","SLE","Suncare","Sunmed","Super Star","Systel","Takaoka","Unimed","UTAH","Valleylab","Vicking","View Sonic","WechAllyn","WEM","Yuwell"];

const MODELOS_EQUIPO = ["60H","600 S","7B-1","7E-C","7E-G","7F-10","7F-5 Mini","9F-5","Autocat II","Autocat II Wave","Beneheart R3","Biomax 500","BT-350","BT-400","BT-500","C-12R","Capnomac","Capnomac Ultima","Cardiolife","Cardiosuny","Caris Plus","CC20","Cloud","CMS8000","CO2-M01","Covidien","D3","DB9","Desconocido","EN-S7","EN-V7","Evergo","Fabius","Fabius Plus","Fabius Plus XL","Force","Graph","Graphnet TS","HC100","Heart Start","HT-109","iE-101","iE-300","IM8B","iMEC10","Infinity Vista","Jay-5","Jay-5Q","LG103","Libra","M3A","MR810","NP-100","NP-600","OXI-3 Plus","Prisma Vent 40","Prisma Vent 50","Puritan Bennett 560","RG-401","RG-401 Plus","RG-501","RG-501 Plus","S3","Scio Four","SP-50","SP-50 Pro","Spirit 3","Star 8000","System 97","System 97e","Trilogy","Vapor 2000","Vista 120","VP-50","VP-50 Pro","YH-350","YH-360","YH-550","YH-560","YH-725","YH-730","5342","5346"];

let selectorCurrentCell = null;
let selectorCurrentType = null;
let selectorCurrentList = [];

function abrirModalSelector(cell, type, items) {
    selectorCurrentCell = cell;
    selectorCurrentType = type;
    selectorCurrentList = items;
    
    const titles = {
        'tipo': 'Seleccionar Tipo de Equipo',
        'marca': 'Seleccionar Marca',
        'modelo': 'Seleccionar Modelo'
    };
    
    document.getElementById('selectorTitle').textContent = titles[type];
    document.getElementById('selectorSearch').value = '';
    
    renderSelectorList(items);
    document.getElementById('modalSelector').style.display = 'flex';
    document.getElementById('selectorSearch').focus();
}

function cerrarModalSelector() {
    document.getElementById('modalSelector').style.display = 'none';
    selectorCurrentCell = null;
    selectorCurrentType = null;
}

function renderSelectorList(items) {
    const listContainer = document.getElementById('selectorList');
    listContainer.innerHTML = '';
    
    items.forEach(function(item) {
        const div = document.createElement('div');
        div.textContent = item;
        div.style.cssText = 'padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;';
        div.addEventListener('mouseenter', function() { this.style.backgroundColor = '#f0f0f0'; });
        div.addEventListener('mouseleave', function() { this.style.backgroundColor = ''; });
        div.addEventListener('click', function() { seleccionarOpcion(item); });
        listContainer.appendChild(div);
    });
    
    const divAgregar = document.createElement('div');
    divAgregar.innerHTML = '‚ûï <strong>Agregar nuevo...</strong>';
    divAgregar.style.cssText = 'padding: 12px 15px; cursor: pointer; background: #e8f4f8; font-weight: bold; color: #1e4d7b;';
    divAgregar.addEventListener('mouseenter', function() { this.style.backgroundColor = '#d0e7f0'; });
    divAgregar.addEventListener('mouseleave', function() { this.style.backgroundColor = '#e8f4f8'; });
    divAgregar.addEventListener('click', function() {
        cerrarModalSelector();
        const modals = {
            'tipo': 'modalNuevoTipo',
            'marca': 'modalNuevaMarca',
            'modelo': 'modalNuevoModelo'
        };
        document.getElementById(modals[selectorCurrentType]).style.display = 'flex';
    });
    listContainer.appendChild(divAgregar);
}

function seleccionarOpcion(valor) {
    if (!selectorCurrentCell) return;
    
    const equipoId = selectorCurrentCell.getAttribute('data-id');
    const field = selectorCurrentCell.getAttribute('data-field');
    
    selectorCurrentCell.textContent = valor;
    
    const data = {};
    data[field] = valor;
    
    fetch('/api/equipo/' + equipoId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
        if (result.success) {
            const rowIndex = selectorCurrentCell.getAttribute('data-row');
            document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                c.style.backgroundColor = '#d4edda';
            });
            setTimeout(function() {
                document.querySelectorAll('[data-row="' + rowIndex + '"]').forEach(function(c) {
                    c.style.backgroundColor = '';
                });
            }, 1500);
        }
    });
    
    cerrarModalSelector();
}

document.getElementById('selectorSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filteredItems = selectorCurrentList.filter(function(item) {
        return item.toLowerCase().includes(searchTerm);
    });
    renderSelectorList(filteredItems);
});

document.querySelectorAll('.editable-select').forEach(function(cell) {
    cell.addEventListener('click', function() {
        const type = this.getAttribute('data-type');
        const lists = {
            'tipo': TIPOS_EQUIPO,
            'marca': MARCAS,
            'modelo': MODELOS_EQUIPO
        };
        abrirModalSelector(this, type, lists[type]);
    });
});

document.getElementById('modalSelector').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalSelector(); }
});

// Modal Nuevo Tipo
function cerrarModalNuevoTipo() {
    document.getElementById('modalNuevoTipo').style.display = 'none';
    document.getElementById('formNuevoTipo').reset();
}

document.getElementById('modalNuevoTipo').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevoTipo(); }
});

document.getElementById('formNuevoTipo').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevoTipo = document.getElementById('inputNuevoTipo').value.trim();
    if (!nuevoTipo) return;
    
    TIPOS_EQUIPO.push(nuevoTipo);
    TIPOS_EQUIPO.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo_equipo: nuevoTipo })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevoTipo;
                alert('‚úÖ Nuevo tipo agregado');
            }
        });
    }
    cerrarModalNuevoTipo();
});

// Modal Nueva Marca
function cerrarModalNuevaMarca() {
    document.getElementById('modalNuevaMarca').style.display = 'none';
    document.getElementById('formNuevaMarca').reset();
}

document.getElementById('modalNuevaMarca').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevaMarca(); }
});

document.getElementById('formNuevaMarca').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevaMarca = document.getElementById('inputNuevaMarca').value.trim();
    if (!nuevaMarca) return;
    
    MARCAS.push(nuevaMarca);
    MARCAS.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ marca: nuevaMarca })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevaMarca;
                alert('‚úÖ Nueva marca agregada');
            }
        });
    }
    cerrarModalNuevaMarca();
});

// Modal Nuevo Modelo
function cerrarModalNuevoModelo() {
    document.getElementById('modalNuevoModelo').style.display = 'none';
    document.getElementById('formNuevoModelo').reset();
}

document.getElementById('modalNuevoModelo').addEventListener('click', function(e) {
    if (e.target === this) { cerrarModalNuevoModelo(); }
});

document.getElementById('formNuevoModelo').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuevoModelo = document.getElementById('inputNuevoModelo').value.trim();
    if (!nuevoModelo) return;
    
    MODELOS_EQUIPO.push(nuevoModelo);
    MODELOS_EQUIPO.sort();
    
    if (selectorCurrentCell) {
        const equipoId = selectorCurrentCell.getAttribute('data-id');
        fetch('/api/equipo/' + equipoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ modelo: nuevoModelo })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                selectorCurrentCell.textContent = nuevoModelo;
                alert('‚úÖ Nuevo modelo agregado');
            }
        });
    }
    cerrarModalNuevoModelo();
});
</script>
{% endblock %}